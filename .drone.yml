---
kind: pipeline
type: docker
name: default
workspace:
  base: /app
steps:
- name: unit-test
  image: devinchristianson/birdspotter:dev-deps
  pull: always
  commands:
    - cd /app/birdspotter
    - python manage.py makemigrations && python manage.py migrate
    - coverage run --source='.' manage.py test
    - coverage report
    - coverage xml
- name: coverage
  image: plugins/codecov
  depends_on: [ unit-test ]
  settings:
    token: 
        from_secret: codecov_token
    files:
     - /app/birdspotter/coverage.xml
- name: linter-tests
  image: devinchristianson/birdspotter:dev-deps
  pull: always
  commands:
    - cd /app/birdspotter
    - prospector
- name: publish-dev-image
  depends_on: [unit-test, linter-tests]
  when:
    status: 
      - success
    event: 
      - push
  image: plugins/docker
  settings:
    repo: devinchristianson/birdspotter
    username: 
      from_secret: dockerhub_username
    password: 
      from_secret: dockerhub_password
    dockerfile: docker/Dockerfile
    context: birdspotter/
    target: prod
    tags: 
      - dev
- name: publish-latest-image
  depends_on: [unit-test, linter-tests]
  when:
    status: 
      - success
    event: 
      - tag
  image: plugins/docker
  settings:
    repo: devinchristianson/birdspotter
    username: 
      from_secret: dockerhub_username
    password: 
      from_secret: dockerhub_password
    dockerfile: docker/Dockerfile
    context: birdspotter/
    target: prod
    auto_tag: true
    tags: 
      - latest
trigger:
  branch:
    - master
  event:
    - push
    - pull_request
    - tag
---
kind: signature
hmac: 83431f3922b35ac7eca0cb79daf7952822db68de9e9525e2b0bed7b8b3850a30

...
